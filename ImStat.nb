(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 8.1' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       157,          7]
NotebookDataLength[     15141,        465]
NotebookOptionsPosition[     12945,        386]
NotebookOutlinePosition[     13277,        401]
CellTagsIndexPosition[     13234,        398]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["Config", "Section",
 CellChangeTimes->{{3.550245825308876*^9, 3.550245825892906*^9}}],

Cell["Source folder for JPG files", "Text",
 CellChangeTimes->{{3.550245832237876*^9, 3.550245844989472*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"jpgFileNames", "=", 
   RowBox[{"FileNames", "[", 
    RowBox[{
     RowBox[{"\"\<*.jpg\>\"", "|", "\"\<*.JPG\>\""}], ",", 
     "\"\</media/superraid/images/images/\>\"", ",", "\[Infinity]"}], "]"}]}],
   ";"}]], "Input",
 CellChangeTimes->{{3.549888177661047*^9, 3.549888290938822*^9}}],

Cell["Number of images found:", "Text",
 CellChangeTimes->{{3.55024584842925*^9, 3.550245854908599*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Length", "[", "jpgFileNames", "]"}]], "Input",
 CellChangeTimes->{{3.5498882934807987`*^9, 3.549888298490912*^9}}],

Cell[BoxData["2881"], "Output",
 CellChangeTimes->{3.549888299081493*^9, 3.550241976742208*^9, 
  3.5502456322503366`*^9, 3.550246387586069*^9}]
}, Open  ]],

Cell["Folder for local data storage:", "Text",
 CellChangeTimes->{{3.550245859541367*^9, 3.550245876277289*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"dataDir", "=", 
  RowBox[{"FileNameJoin", "[", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"NotebookDirectory", "[", "]"}], ",", "\"\<dataStorage\>\""}], 
    "}"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.5502420467395773`*^9, 3.550242067313099*^9}, {
  3.5502422952743998`*^9, 3.550242302694582*^9}}],

Cell[BoxData["\<\"/home/malte/dev/imStat/dataStorage\"\>"], "Output",
 CellChangeTimes->{
  3.550242054235429*^9, 3.550242303964595*^9, 3.5502457555233927`*^9, {
   3.550246366589756*^9, 3.550246387689384*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"CreateDirectory", "[", "dataDir", "]"}]], "Input",
 CellChangeTimes->{{3.5502423067451077`*^9, 3.55024231304856*^9}}],

Cell[BoxData["\<\"/home/malte/dev/imStat/dataStorage\"\>"], "Output",
 CellChangeTimes->{3.550242313596828*^9, 3.550245756335885*^9}]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["\<\
Retrieve mini JPG files and basic data\
\>", "Section",
 CellChangeTimes->{{3.549888160485299*^9, 3.549888174093144*^9}, {
  3.55024579096796*^9, 3.55024581442983*^9}}],

Cell["\<\
Compute data file name from original path:\
\>", "Text",
 CellChangeTimes->{{3.550245894804654*^9, 3.5502459055406446`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"storageFile", "[", "path_", "]"}], ":=", 
   RowBox[{"FileNameJoin", "[", 
    RowBox[{"{", 
     RowBox[{"dataDir", ",", 
      RowBox[{
       RowBox[{"ToString", "[", 
        RowBox[{"Hash", "[", "path", "]"}], "]"}], "<>", "\"\<.dst\>\""}]}], 
     "}"}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.550245111358528*^9, 3.550245122107691*^9}, {
  3.550245418515723*^9, 3.5502454307167187`*^9}, {3.550245501159943*^9, 
  3.5502455015326977`*^9}, {3.550246352212985*^9, 3.5502463713503942`*^9}}],

Cell["\<\
Fetch original image and save data into data file:\
\>", "Text",
 CellChangeTimes->{{3.550245910021288*^9, 3.550245924380706*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"createData", "[", "path_", "]"}], "/;", 
    RowBox[{"FileExistsQ", "[", 
     RowBox[{"storageFile", "[", "path", "]"}], "]"}]}], "=", "Null"}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.55024625862799*^9, 3.550246267316386*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"createData", "[", "path_", "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "img", ",", "dimensions", ",", "smallImg", ",", "aperture", ",", 
      "bitDepth", ",", "orientation", ",", "colorSpace", ",", "date", ",", 
      "exposure", ",", "focalLength", ",", "imageSize", ",", "iso", ",", 
      "manufacturer", ",", "model"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"img", "=", 
      RowBox[{"Import", "[", "path", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"dimensions", "=", 
      RowBox[{"ImageDimensions", "[", "img", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"smallImg", "=", 
      RowBox[{"ImageResize", "[", 
       RowBox[{"img", ",", 
        RowBox[{"{", "300", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "aperture", ",", "bitDepth", ",", "orientation", ",", "colorSpace", 
        ",", "date", ",", "exposure", ",", "focalLength", ",", "imageSize", 
        ",", "iso", ",", "manufacturer", ",", "model"}], "}"}], "=", 
      RowBox[{"Import", "[", 
       RowBox[{"path", ",", 
        RowBox[{"{", 
         RowBox[{"{", 
          RowBox[{
          "\"\<Aperture\>\"", ",", "\"\<BitDepth\>\"", ",", 
           "\"\<CameraTopOrientation\>\"", ",", "\"\<ColorSpace\>\"", ",", 
           "\"\<Date\>\"", ",", "\"\<Exposure\>\"", ",", 
           "\"\<FocalLength\>\"", ",", "\"\<ImageSize\>\"", ",", 
           "\"\<ISOSpeed\>\"", ",", "\"\<Manufacturer\>\"", ",", 
           "\"\<Model\>\""}], "}"}], "}"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Put", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "smallImg", ",", "dimensions", ",", "aperture", ",", "bitDepth", ",", 
         "orientation", ",", "colorSpace", ",", "date", ",", "exposure", ",", 
         "focalLength", ",", "imageSize", ",", "iso", ",", "manufacturer", 
         ",", "model"}], "}"}], ",", 
       RowBox[{"storageFile", "[", "path", "]"}]}], "]"}], ";"}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.550243671952941*^9, 3.55024385290099*^9}, {
  3.550244981447057*^9, 3.5502450361800756`*^9}, {3.550245099195249*^9, 
  3.550245129722575*^9}, {3.550245257717059*^9, 3.550245271758568*^9}}],

Cell["\<\
Fetch data in order of preference {memory, data file, source image}:\
\>", "Text",
 CellChangeTimes->{{3.5502459311329517`*^9, 3.5502459700846233`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"getData", "[", "path_", "]"}], "/;", 
   RowBox[{"FileExistsQ", "[", 
    RowBox[{"storageFile", "[", "path", "]"}], "]"}]}], ":=", 
  RowBox[{
   RowBox[{"getData", "[", "path", "]"}], "=", 
   RowBox[{"Get", "[", 
    RowBox[{"storageFile", "[", "path", "]"}], 
    "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"getData", "[", "path_", "]"}], ":=", 
  RowBox[{"(", 
   RowBox[{
    RowBox[{"createData", "[", "path", "]"}], ";", 
    RowBox[{"getData", "[", "path", "]"}]}], ")"}]}]}], "Input",
 CellChangeTimes->{{3.550245060412002*^9, 3.550245091301409*^9}, {
  3.550245134492662*^9, 3.550245158277285*^9}, {3.550245334892378*^9, 
  3.550245392121121*^9}, {3.5502455568374653`*^9, 3.550245559539933*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Test image data retrieval", "Section",
 CellChangeTimes->{{3.550245988502268*^9, 3.550245998652829*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"iName", "=", 
  RowBox[{"jpgFileNames", "[", 
   RowBox[{"[", "7", "]"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.550245457810968*^9, 3.550245490715218*^9}, 
   3.550245597180773*^9, 3.550245684555492*^9, 3.550245769765712*^9}],

Cell[BoxData["\<\"/media/superraid/images/images/2007/2007-12-26--15.26.07/\
IMG_5910_autowb.jpg\"\>"], "Output",
 CellChangeTimes->{{3.550245455559497*^9, 3.55024550593045*^9}, {
   3.550245569773149*^9, 3.5502455973932753`*^9}, 3.550245638526659*^9, 
   3.550245685133007*^9, 3.550245770061264*^9, {3.550246025985064*^9, 
   3.55024604756348*^9}}]
}, Open  ]],

Cell["First fetch takes long:", "Text",
 CellChangeTimes->{{3.550246078829135*^9, 3.550246089989563*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"AbsoluteTiming", "[", 
  RowBox[{
   RowBox[{"getData", "[", "iName", "]"}], ";"}], "]"}]], "Input",
 CellChangeTimes->{{3.550245397478837*^9, 3.550245401178404*^9}, {
  3.5502454703967123`*^9, 3.550245474867803*^9}, {3.550245671669345*^9, 
  3.550245676681868*^9}}],

Cell[BoxData[
 RowBox[{
  StyleBox[
   RowBox[{"ICCObject", "::", "iccinv"}], "MessageName"], 
  RowBox[{
  ":", " "}], "\<\"-- Message text not found -- \
(\[NoBreak]\\!\\(\\*TagBox[\\(ICCObject[]\\), False, Rule[Editable, \
False]]\\)\[NoBreak])\"\>"}]], "Message", "MSG",
 CellChangeTimes->{3.5502456919860907`*^9, 3.550245777011971*^9}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"4.11746`7.0661743823059115", ",", "Null"}], "}"}]], "Output",
 CellChangeTimes->{{3.550245676987631*^9, 3.5502456919884167`*^9}, 
   3.5502457770143843`*^9}]
}, Open  ]],

Cell["Fetching from memory:", "Text",
 CellChangeTimes->{{3.550246095957047*^9, 3.550246099980908*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"AbsoluteTiming", "[", 
  RowBox[{
   RowBox[{"getData", "[", "iName", "]"}], ";"}], "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"0.00004`2.053604984823933", ",", "Null"}], "}"}]], "Output",
 CellChangeTimes->{3.550245692222348*^9, 3.550245778729011*^9}]
}, Open  ]],

Cell[BoxData["Quit"], "Input",
 CellChangeTimes->{{3.550245603976643*^9, 3.55024560445613*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"iName", "=", 
   RowBox[{"jpgFileNames", "[", 
    RowBox[{"[", "7", "]"}], "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.550245457810968*^9, 3.550245490715218*^9}, 
   3.550245597180773*^9, 3.550245684555492*^9, 3.550245769765712*^9, 
   3.550246058292466*^9}],

Cell["Fetching from local data file:", "Text",
 CellChangeTimes->{{3.550246104420312*^9, 3.550246115068654*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"AbsoluteTiming", "[", 
  RowBox[{
   RowBox[{"getData", "[", "iName", "]"}], ";"}], "]"}]], "Input",
 CellChangeTimes->{3.55024603373934*^9}],

Cell[BoxData[
 RowBox[{
  StyleBox[
   RowBox[{"ICCObject", "::", "iccinv"}], "MessageName"], 
  RowBox[{
  ":", " "}], "\<\"-- Message text not found -- \
(\[NoBreak]\\!\\(\\*TagBox[\\(ICCObject[]\\), False, Rule[Editable, \
False]]\\)\[NoBreak])\"\>"}]], "Message", "MSG",
 CellChangeTimes->{3.550246049222822*^9}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"0.366232`6.01530128216796", ",", "Null"}], "}"}]], "Output",
 CellChangeTimes->{{3.550246023301194*^9, 3.550246049264524*^9}}]
}, Open  ]],

Cell["Fetching from memory:", "Text",
 CellChangeTimes->{{3.5502461183085823`*^9, 3.5502461239091883`*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"AbsoluteTiming", "[", 
  RowBox[{
   RowBox[{"getData", "[", "iName", "]"}], ";"}], "]"}]], "Input"],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"0.000041`2.0643288502157104", ",", "Null"}], "}"}]], "Output",
 CellChangeTimes->{3.550246074292582*^9}]
}, Open  ]]
}, Closed]],

Cell[CellGroupData[{

Cell["Retrieve image data", "Section",
 CellChangeTimes->{{3.550246173701167*^9, 3.550246177357382*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Monitor", "[", "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"ParallelDo", "[", 
    RowBox[{
     RowBox[{"createData", "[", 
      RowBox[{"jpgFileNames", "[", 
       RowBox[{"[", "i", "]"}], "]"}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", 
       RowBox[{"Length", "[", "jpgFileNames", "]"}]}], "}"}]}], "]"}], ",", 
   "\[IndentingNewLine]", 
   RowBox[{"Refresh", "[", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"ProgressIndicator", "[", 
      RowBox[{
       RowBox[{"Length", "@", 
        RowBox[{"FileNames", "[", 
         RowBox[{"\"\<*\>\"", ",", "dataDir"}], "]"}]}], ",", 
       RowBox[{"{", 
        RowBox[{"0", ",", 
         RowBox[{"Length", "[", "jpgFileNames", "]"}]}], "}"}]}], "]"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"UpdateInterval", "\[Rule]", "0.5"}], ",", "\[IndentingNewLine]", 
     RowBox[{"TrackedSymbols", "\[Rule]", 
      RowBox[{"{", "}"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  "\[IndentingNewLine]", "]"}]], "Input",
 CellChangeTimes->{{3.550246179973894*^9, 3.550246207113903*^9}, {
   3.550246291303256*^9, 3.5502462926129417`*^9}, 3.550246333471834*^9, {
   3.550246445637561*^9, 3.5502464815180483`*^9}, {3.550246609462536*^9, 
   3.550246654199901*^9}, {3.550246822486741*^9, 3.550246831521763*^9}, {
   3.5502468663777018`*^9, 3.550246936618702*^9}, {3.550247003071581*^9, 
   3.5502470260890827`*^9}}],

Cell[BoxData[
 DynamicBox[ToBoxes[
   Refresh[
    ProgressIndicator[
     Length[
      FileNames["*", $CellContext`dataDir]], {0, 
      Length[$CellContext`jpgFileNames]}], UpdateInterval -> 0.5, 
    TrackedSymbols -> {}], StandardForm],
  Evaluator->"Local",
  ImageSizeCache->{200., {5., 11.}}]], "PrintTemporary",
 CellChangeTimes->{3.550246937988299*^9}]
}, Open  ]]
}, Open  ]]
},
WindowSize->{740, 720},
WindowMargins->{{24, Automatic}, {31, Automatic}},
FrontEndVersion->"8.1 for Linux x86 (64-bit) (May 25, 2011)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[579, 22, 91, 1, 74, "Section"],
Cell[673, 25, 109, 1, 30, "Text"],
Cell[785, 28, 323, 8, 52, "Input"],
Cell[1111, 38, 104, 1, 30, "Text"],
Cell[CellGroupData[{
Cell[1240, 43, 138, 2, 30, "Input"],
Cell[1381, 47, 144, 2, 30, "Output"]
}, Open  ]],
Cell[1540, 52, 112, 1, 30, "Text"],
Cell[CellGroupData[{
Cell[1677, 57, 327, 8, 30, "Input"],
Cell[2007, 67, 210, 3, 30, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[2254, 75, 141, 2, 30, "Input"],
Cell[2398, 79, 133, 1, 30, "Output"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[2580, 86, 178, 4, 74, "Section"],
Cell[2761, 92, 134, 3, 30, "Text"],
Cell[2898, 97, 549, 13, 30, "Input"],
Cell[3450, 112, 140, 3, 30, "Text"],
Cell[3593, 117, 290, 8, 30, "Input"],
Cell[3886, 127, 2334, 51, 335, "Input"],
Cell[6223, 180, 162, 3, 30, "Text"],
Cell[6388, 185, 766, 19, 69, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[7191, 209, 110, 1, 74, "Section"],
Cell[CellGroupData[{
Cell[7326, 214, 252, 5, 30, "Input"],
Cell[7581, 221, 349, 5, 50, "Output"]
}, Open  ]],
Cell[7945, 229, 105, 1, 30, "Text"],
Cell[CellGroupData[{
Cell[8075, 234, 290, 6, 30, "Input"],
Cell[8368, 242, 340, 8, 24, "Message"],
Cell[8711, 252, 197, 4, 30, "Output"]
}, Open  ]],
Cell[8923, 259, 103, 1, 30, "Text"],
Cell[CellGroupData[{
Cell[9051, 264, 124, 3, 30, "Input"],
Cell[9178, 269, 164, 3, 30, "Output"]
}, Open  ]],
Cell[9357, 275, 95, 1, 30, "Input"],
Cell[9455, 278, 298, 7, 30, "Input"],
Cell[9756, 287, 112, 1, 30, "Text"],
Cell[CellGroupData[{
Cell[9893, 292, 165, 4, 30, "Input"],
Cell[10061, 298, 316, 8, 24, "Message"],
Cell[10380, 308, 166, 3, 30, "Output"]
}, Open  ]],
Cell[10561, 314, 107, 1, 30, "Text"],
Cell[CellGroupData[{
Cell[10693, 319, 124, 3, 30, "Input"],
Cell[10820, 324, 144, 3, 30, "Output"]
}, Open  ]]
}, Closed]],
Cell[CellGroupData[{
Cell[11013, 333, 104, 1, 44, "Section"],
Cell[CellGroupData[{
Cell[11142, 338, 1410, 32, 183, "Input"],
Cell[12555, 372, 362, 10, 26, "PrintTemporary"]
}, Open  ]]
}, Open  ]]
}
]
*)

(* End of internal cache information *)
